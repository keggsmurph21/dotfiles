#!/bin/bash
#
# Sort branches by most-recently-committed-to.  Can be git-aliased :^)

set -euo pipefail

X="%(color:reset)"
b="%(color:bold)"
g="%(color:green)"
r="%(color:red)"
y="%(color:yellow)"

# ascii hex code for newline
N="%0a"

read -r FORMAT <<FORMAT
$b$r%(HEAD)$X $b$y%(refname:short)$X [$r%(objectname:short)$X] $g%(committerdate:relative)$X by $b%(authorname)$X$N \
    %(contents:subject)$N
FORMAT

refs="refs/heads refs/remotes refs/stash"
if [[ $# -eq 1 ]]; then
    case "$1" in
        --local)    shift && refs=refs/heads ;;
        --remote)   shift && refs=refs/remotes/origin ;;
    esac
fi

git for-each-ref \
        --sort=-committerdate \
        --color=always \
        --format="$FORMAT" \
        $refs \
        "$@" \
    | less -R
