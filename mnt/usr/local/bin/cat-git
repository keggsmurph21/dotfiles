#!/bin/sh -e

usage() {

	echo "	usage:"
	echo "		(list) $ cat-git <repo>"
	echo "		(cat)  $ cat-git <repo> <branch> <path/to/file>"
	exit 1

}

if [ -z $1 ]; then
	usage
fi

if [ -z $GITHUB_TOKEN ]; then
    echo "cat-git: No secret token provided :("
    exit 2
fi

GET() {
	curl -s -H "Authorization: token $GITHUB_TOKEN" -H "ref: $2" "$API_URL$1" 
}

_() {
	echo "$1" | jq -r ".$2"
}

API_URL=https://api.github.com
RAW_URL=https://raw.githubusercontent.com
OWNER=keggsmurph21
REPO="$1"
FILEPATH="$2"
BRANCH=master
if [ ! -z $3 ]; then
    FILEPATH="$3"
    BRANCH="$2"
fi

echo "# https://github.com/$OWNER/$REPO/tree/$BRANCH/$FILEPATH" > /dev/stderr

file=$(GET "/repos/$OWNER/$REPO/contents/$FILEPATH" "$BRANCH" | jq -c '')
if [[ "$file" == {* ]]; then 
    
    curl -s "$RAW_URL/$OWNER/$REPO/$BRANCH/$FILEPATH"

else
    for file in $(GET "/repos/$OWNER/$REPO/contents/$FILEPATH" "$BRANCH" | jq -c '.[]'); do
        case $(_ $file type) in
            dir)
                echo "$(_ $file path)/"
                ;;
            file)
                _ $file path
                ;;
        esac
    done
fi
