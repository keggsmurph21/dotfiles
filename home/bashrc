# If not running interactively, don't do anything
[[ $- != *i* ]] && return

shopt -s histappend
shopt -s checkwinsize
shopt -s globstar

HISTCONTROL=ignoreboth
HISTSIZE=1000
HISTFILESIZE=2000
HISTIGNORE="pwd"

# prompt
__prompt_rc_color() {
    if [[ $? -eq 0 ]]; then
        echo -e '\e[01;32m' # bright green
    else
        echo -e '\e[0;32m' # normal green
    fi
}
PS1='\[`__prompt_rc_color`\]\u@\h\[\e[0m\]:\[\e[01;34m\]\w\[\e[0m\]\$ '

export DOTFILES_DIR="$HOME/src/keggsmurph21/dotfiles"
export PATH="$HOME/.local/bin:$DOTFILES_DIR/bin:$HOME/.cargo/bin:$PATH"
export EDITOR=vim
export VISUAL=vim
export VIRTUALENVWRAPPER_SCRIPT=~/.local/bin/virtualenvwrapper.sh
export WORKON_HOME=~/.virtualenvs
export PIP_REQUIRE_VIRTUALENV=true
export PIP_DOWNLOAD_CACHE="$HOME/.cache/pip"
export NVM_DIR="$HOME/.nvm"
export GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'

if which go &>/dev/null; then
    export GOPATH=$(go env GOPATH)
    export PATH="$PATH:$GOPATH/bin"
fi

# system aliases
alias sudo="sudo " # allow $ sudo <alias>
alias vi=vim
alias pip="python -m pip"
alias g=git
alias pwd="pwd -P"
alias tree="tree -a -I '.git|__pycache__|*.pyc'"
alias grep="grep --color=auto --devices=skip -I"
alias cat="cat -v" # show ^/M- escapes for nonprintable chars

# edit bash config file && source it
alias bashrc="vim $HOME/.bashrc && . $HOME/.bashrc"
alias bashrclocal="vim $HOME/.bashrc.local && . $HOME/.bashrc"
alias bashrcmacos="vim $HOME/.bashrc.macos && . $HOME/.bashrc"
alias bashrclinux="vim $HOME/.bashrc.linux && . $HOME/.bashrc"

# other quick edit-config-file shortcuts
alias bashprofile="vim $HOME/.bash_profile"
alias bashlogout="vim $HOME/.bash_logout"
alias vimrc="vim $HOME/.vimrc"
alias sshconf="vim $HOME/.ssh/config"
alias gitconf="vim $HOME/.gitconfig"
alias inputrc="vim $HOME/.inputrc"
alias xinitrc="vim $HOME/.xinitrc"

# custom aliases
alias peek='tee >(cat 1>&2)' # mirror stdout to stderr (for seeing data thru pipe)
alias gtrim="trim \$(git status --porcelain | sed 's/^...//g')"
alias ipaddr="curl https://api.ipify.org/"

# trim whitespace
trim() {
    for file in "$@"; do
        sed -E 's/\s+$//g' -i $file
    done
}

# see where python is importing a module from
pywhich() {
    for module in "$@"; do
        python -c "import $module; print($module.__file__)";
    done
}
pywhich3() {
    for module in "$@"; do
        python3 -c "import $module; print($module.__file__)";
    done
}

# pip without a venv
gpip() {
    PIP_REQUIRE_VIRTUALENV="" pip "$@"
}

git-find() {
    git ls-files $(git root) | grep "$@"
}

__src() {
    [ -r "$1" ] && . "$1" &>/dev/null || true
}

# source external files
__src "/usr/share/bash-completion/bash_completion"
__src "$HOME/.tokens"
__src "$HOME/src/keggsmurph21/backstack/backstack.bash"
__src "$HOME/.local/bin/virtualenvwrapper_lazy.sh"
__src "$HOME/.opam/opam-init/init.sh"
__src "$HOME/src/keggsmurph21/wt/scripts/wt.bash"
__src "$NVM_DIR/nvm.sh"
__src "$NVM_DIR/bash_completion"
case "$OSTYPE" in
    linux-gnu)  __src "$HOME/.bashrc.linux" ;;
    darwin*)    __src "$HOME/.bashrc.macos" ;;
    *)          echo "unrecognized OSTYPE: $OSTYPE" >&2 ;;
esac
__src "$HOME/.bashrc.local"

unset __src

# start the ssh-agent
eval "$(ssh-agent)" >/dev/null
